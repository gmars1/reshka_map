<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Wiki Data Scraper</title>
</head>
<body>
    <h1>Данные «Орел и Решка»</h1>
    <div id="status">Загрузка...</div>
    <div id="output"></div>

    <script>
        const statusEl = document.getElementById('status');
        const outputEl = document.getElementById('output');

        async function init() {
            const rawText = await fetchData();
            if (rawText) {
                parseAndDisplay(rawText);
            }
        }

        async function fetchData() {
            const apiUrl = "https://cyclowiki.org/w/api.php?" + 
                new URLSearchParams({
                    action: "parse",
                    page: "Выпуски_телепередачи_«Орёл_и_решка»",
                    section: "2",
                    prop: "wikitext",
                    format: "json",
                    origin: "*" 
                });

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Ошибка сети: ${response.status}`);
                
                const data = await response.json();
                if (data.parse && data.parse.wikitext) {
                    return data.parse.wikitext["*"];
                }
            } catch (error) {
                statusEl.innerText = "❌ Ошибка: " + error.message;
                statusEl.style.color = "red";
                console.error(error);
            }
        }

        function parseAndDisplay(mediaWiki) {
            const rows = mediaWiki.split(/\|-/);
            const episodes = [];
        
            rows.forEach(row => {
                const cleanRow = row.trim();
                if (!cleanRow || cleanRow.startsWith('!')) return;
        
                // Разбиваем по ячейкам (учтем, что в начале строки тоже может быть |)
                const cells = cleanRow.split(/\|\||(?<=\n)\|/).map(c => c.trim()).filter(c => c !== "");
                
                if (cells.length >= 1) {
                    // 1. Ищем Индекс. Обычно это первая ячейка, где есть цифры в кавычках '''1 (1)'''
                    let indexCell = cells.find(c => c.match(/'''\d+/)) || cells[0];
                    let index = indexCell.replace(/\|/g, '').replace(/'''/g, '').trim();
        
                    // 2. Ищем локации во всех ячейках (на случай списков)
                    let locations = [];
                    
                    cells.forEach(cell => {
                        // Ищем все конструкции [[...]], исключая файлы
                        const matches = cell.match(/\[\[([^|\]]+)(?:\|[^\]]+)?\]\]/g) || [];
                        matches.forEach(m => {
                            if (!m.toLowerCase().includes('[[файл:')) {
                                const cityName = m.replace(/[\[\]]/g, '').split('|').pop();
                                // Ищем страну рядом (шаблон Флаг)
                                const flagMatch = cell.match(new RegExp(`\\{\\{Флаг\\|([^}|]+)\\}\\}\\s*\\Q${m}\\E`.replace('\\Q', '').replace('\\E', ''))) 
                                                  || cell.match(/\{\{Флаг\|([^}|]+)\}\}/);
                                const countryName = flagMatch ? flagMatch[1].trim() : "";
                                
                                let fullLoc = (countryName && countryName !== cityName) ? `${countryName}, ${cityName}` : cityName;
                                if (!locations.includes(fullLoc)) locations.push(fullLoc);
                            }
                        });
                    });
        
                    if (locations.length > 0) {
                        episodes.push({
                            idx: index,
                            location: locations.join('; ') // Если городов несколько, пишем через ;
                        });
                    }
                }
            });
        
            statusEl.innerText = `Найдено записей: ${episodes.length}`;
            outputEl.innerHTML = '<ul style="list-style: none; padding: 0;">' + 
                episodes.map(item => `<li style="margin-bottom: 8px;"><strong>${item.idx}.</strong> ${item.location}</li>`).join('') + 
                '</ul>';
        }

        // Запуск
        init();
    </script>
</body>
</html>
