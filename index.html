<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Wiki Data Scraper</title>
</head>
<body>
    <h1>Данные «Орел и Решка»</h1>
    <div id="status">Загрузка...</div>
    <div id="output"></div>

    <script>
        const statusEl = document.getElementById('status');
        const outputEl = document.getElementById('output');

        async function init() {
            const rawText = await fetchData();
            if (rawText) {
                parseAndDisplay(rawText);
            }
        }

        async function fetchData() {
            const apiUrl = "https://cyclowiki.org/w/api.php?" + 
                new URLSearchParams({
                    action: "parse",
                    page: "Выпуски_телепередачи_«Орёл_и_решка»",
                    section: "2",
                    prop: "wikitext",
                    format: "json",
                    origin: "*" 
                });

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Ошибка сети: ${response.status}`);
                
                const data = await response.json();
                if (data.parse && data.parse.wikitext) {
                    return data.parse.wikitext["*"];
                }
            } catch (error) {
                statusEl.innerText = "❌ Ошибка: " + error.message;
                statusEl.style.color = "red";
                console.error(error);
            }
        }

        function parseAndDisplay(mediaWiki) {
            const lines = mediaWiki.split('\n');
            const episodes = [];
        
            lines.forEach(line => {
                if (line.startsWith('|') && !line.startsWith('|-') && !line.startsWith('| }')) {
                    const cells = line.split('||');
                    
                    if (cells.length > 1) {
                        // 1. Индекс
                        let index = cells[0].replace(/\|/g, '').replace(/'''/g, '').trim();
        
                        // 2. Город и Страна
                        const cityCell = cells[1].trim();
                        // Находим все вхождения [[...]], исключая файлы картинок
                        const allLinks = cityCell.match(/\[\[([^|\]]+)(?:\|[^\]]+)?\]\]/g) || [];
                        
                        // Фильтруем ссылки, чтобы убрать возможные [[Файл:...]]
                        const cleanLinks = allLinks.filter(link => !link.toLowerCase().includes('[[файл:'));
        
                        let locationText = "";
        
                        if (cleanLinks.length >= 2) {
                            // Если есть флаг страны, то обычно формат: {{Флаг|Страна}} [[Страна]] [[Город]]
                            const country = cleanLinks[0].replace(/[\[\]]/g, '').split('|')[0];
                            const city = cleanLinks[1].replace(/[\[\]]/g, '').split('|')[0];
                            locationText = `${country}, ${city}`;
                        } else if (cleanLinks.length === 1) {
                            // Если ссылка только одна
                            locationText = cleanLinks[0].replace(/[\[\]]/g, '').split('|')[0];
                        }
        
                        if (locationText) {
                            episodes.push({
                                idx: index,
                                location: locationText
                            });
                        }
                    }
                }
            });
        
            statusEl.innerText = `Найдено выпусков: ${episodes.length}`;
            
            outputEl.innerHTML = '<ul style="list-style: none; padding: 0;">' + 
                episodes.map(item => `<li><strong>${item.idx}.</strong> ${item.location}</li>`).join('') + 
                '</ul>';
        }

        // Запуск
        init();
    </script>
</body>
</html>
